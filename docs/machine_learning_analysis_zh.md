# SharpEye中的机器学习分析

SharpEye现在结合了机器学习技术来增强其异常检测能力。本文档提供了基于ML的分析功能概述，重点关注系统资源监控。

## 系统资源模式分析

系统资源模块（`SystemResourceAnalyzer`）已经增强了机器学习功能，用于检测可能表明系统受到威胁或存在安全隐患的异常资源使用模式。

### 概述

传统的基于阈值的异常检测是有用的，但存在局限性：
- 固定阈值可能会遗漏微妙的异常
- 无法检测不同资源之间的相关性
- 无法识别随时间发展的模式
- 无法从系统的正常行为中学习

机器学习增强功能通过以下方式解决这些局限性：
- 随时间分析资源使用模式
- 基于与预期行为的偏差检测异常
- 识别不同资源类型之间的相关性
- 识别逐渐演变的可疑趋势和模式

### 实施技术

`ResourcePatternAnalyzer`类实现了多种机器学习和统计分析方法：

1. **无监督异常检测** - 使用隔离森林算法识别异常的资源使用模式
2. **时间序列分析** - 跟踪资源指标随时间变化，以检测异常变化
3. **相关性分析** - 检测不同资源类型之间的可疑相关性
4. **趋势分析** - 使用线性回归识别值得关注的趋势

### 主要功能

#### 1. 历史数据分析

分析器维护资源指标的历史记录，使其能够建立正常行为的基线：
- 可配置的历史长度（默认：24个数据点）
- 从CPU、内存和磁盘数据自动提取特征
- 滚动窗口分析，用于持续监控

#### 2. 机器学习模型

使用三个独立的ML模型来检测不同资源类型中的异常：
- CPU使用模式异常检测
- 内存使用模式异常检测
- 磁盘使用模式异常检测

这些模型使用scikit-learn的隔离森林算法实现，该算法：
- 不需要标记的训练数据
- 适用于高维数据
- 对实时异常检测高效
- 可以在特征空间中检测离群值

#### 3. 跨资源相关性分析

除了单个资源异常外，分析器还检测资源之间的可疑相关性：
- CPU和内存使用模式
- 磁盘I/O和CPU模式
- 系统和用户CPU时间比例
- 异常的资源收敛模式

可检测的常见攻击模式包括：
- 高磁盘I/O但没有相应的CPU使用率（潜在的数据外泄）
- 完全相关的资源使用（潜在的协调攻击）
- 高CPU伴随着可用内存减少（资源耗尽攻击）

#### 4. 统计模式检测

即使没有训练模型，分析器也使用统计方法来识别可疑模式：
- 资源使用突然激增
- 持续高负载
- 异常的系统对用户CPU比率
- 内存碎片增加
- 可疑的进程行为

#### 5. 自训练能力

分析器可以根据观察到的系统行为训练自己的模型：
- 收集足够的历史记录后自动训练模型
- 适应特定系统的基线行为
- 不需要预先标记的训练数据

### 实现细节

#### 特征提取

为了有效的ML分析，原始资源数据被转换为特征向量：

**CPU特征：**
- 总CPU使用率百分比
- 高CPU进程数量
- 异常进程数量
- 隐藏进程数量
- 系统负载平均值
- I/O等待百分比
- 系统CPU百分比
- 用户CPU百分比

**内存特征：**
- 内存使用率百分比
- 交换空间使用率百分比
- 高内存进程数量
- 异常进程数量
- 缓存对空闲内存比率
- 匿名页面数量
- Slab内存使用
- 内存碎片指数

**磁盘特征：**
- 平均文件系统使用率百分比
- 异常文件系统数量
- 可疑目录数量
- 隐藏文件数量
- 大文件数量
- 可疑增长指标
- 权限问题数量
- 修改过的配置文件数量

#### 分析工作流程

机器学习分析遵循以下工作流程：

1. 在系统初始化期间，如果可用则加载ML模型
2. 每次资源分析时，提取指标并添加到历史记录中
3. 如果存在足够的历史记录（≥3个样本），则执行模式分析
4. 使用ML和统计方法检测异常
5. 收集足够的样本（≥10个）后，如果模型尚不可用，则进行训练

#### 与传统分析的集成

基于ML的分析是对传统的基于阈值的检测的补充，而不是替代：
- 传统分析可捕获即时、明显的异常
- ML分析可捕获微妙的、不断发展的或相关的异常
- 最终报告中结合了两种方法的结果

### 配置

可以在SharpEye配置文件中配置基于ML的分析：

```yaml
system_resources:
  # 传统阈值
  cpu_threshold: 90
  memory_threshold: 90
  disk_threshold: 90
  
  # ML配置
  ml_config:
    enable: true               # 启用/禁用ML分析
    history_length: 24         # 历史记录中保留的样本数
    detection_threshold: 0.7   # 异常检测阈值（0-1）
    models_dir: /var/lib/sharpeye/models  # 保存/加载模型的目录
```

### 样本输出

当检测到基于ML的异常时，它们会包含在分析结果中：

```json
{
  "cpu": {
    "is_anomalous": true,
    "ml_detected_anomalies": [
      {
        "type": "ml_detected",
        "description": "机器学习模型检测到CPU使用异常",
        "score": -0.42,
        "severity": "high"
      },
      {
        "type": "io_wait_spike",
        "description": "异常的I/O等待时间峰值：35.2%（平均：5.8%）",
        "severity": "high"
      }
    ]
  },
  "correlation_anomalies": [
    {
      "type": "disk_io_anomaly",
      "description": "高磁盘I/O但没有相应的CPU使用（可能的数据外泄）",
      "severity": "critical"
    }
  ],
  "resource_trends": {
    "cpu_trend": "rapidly_increasing",
    "memory_trend": "stable",
    "disk_trend": "increasing",
    "cpu_slope": 25.3,
    "memory_slope": 3.2,
    "disk_slope": 8.7,
    "is_anomalous": true
  }
}
```

### 未来增强

计划对基于ML的分析进行的未来增强包括：

1. **监督学习模型** - 添加基于已知攻击模式训练模型的能力
2. **深度学习集成** - 整合LSTM网络用于基于序列的异常检测
3. **多系统分析** - 关联多个系统之间的模式
4. **自动响应** - 根据检测到的模式建议缓解措施
5. **用户反馈循环** - 整合用户对误报/漏报的反馈

## 在其他模块中使用ML分析

系统资源模块中实现的机器学习方法提供了一个可以扩展到其他SharpEye模块的框架：

- **用户账户模块** - 检测异常登录模式和用户行为
- **网络模块** - 识别异常网络流量模式
- **进程模块** - 检测异常进程行为和关系
- **SSH模块** - 识别可疑SSH访问模式
- **Rootkit检测** - 增强对复杂rootkit的检测

在这些模块中实现ML分析将遵循类似的模式：
1. 随时间收集相关指标
2. 提取能够捕获重要特征的特征
3. 应用无监督学习进行异常检测
4. 关联不同数据源的发现

## 要求

机器学习功能需要以下Python包：
- numpy
- scikit-learn

这些依赖已包含在SharpEye的requirements.txt文件中。