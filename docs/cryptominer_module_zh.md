# 加密货币挖矿检测模块文档

本文档提供有关SharpEye中加密货币挖矿检测模块的详细技术信息，包括实现细节、配置选项和集成点。

## 目录

1. [概述](#概述)
2. [实现细节](#实现细节)
3. [配置选项](#配置选项)
4. [检测能力](#检测能力)
5. [集成点](#集成点)
6. [机器学习方面](#机器学习方面)

## 概述

加密货币挖矿检测模块（`cryptominer.py`）旨在识别在Linux系统上运行的恶意加密货币挖矿软件。它使用机器学习、CPU使用模式分析和启发式检测的组合来识别可能未经授权挖掘加密货币的进程。

加密货币挖矿程序具有独特的资源利用模式 - 它们通常使用高CPU，保持一致的使用模式，并且可能在其命令名称中包含特定关键字。该模块实现了针对这些行为的复杂检测技术。

## 实现细节

- **类**：`CryptominerDetectionModule`
- **主要方法**：
  - `analyze()`：对所有进程运行检测的入口点
  - `_get_all_processes()`：检索所有进程进行分析
  - `_get_system_load()`：获取系统负载平均值
  - `_start_monitoring()`：启动连续监控线程
  - `_monitoring_loop()`：实现后台监控
  - `establish_baseline()`：创建正常进程的基线
  - `compare_baseline()`：将当前状态与基线进行比较

- **支持类**：
  - `CryptominerDetector`：实现分析的核心检测器
  - `CPUProfiler`：收集进程的CPU使用模式
  - `MLModelManager`：管理用于检测的机器学习模型

## 配置选项

```yaml
cryptominer:
  # 启用连续后台监控
  continuous_monitoring: false
  
  # 监控间隔（秒）
  monitoring_interval: 60
  
  # 启发式检测的特征阈值
  thresholds:
    cpu_stability: 0.2      # 较低的值表示更稳定（可疑）的CPU使用率
    cpu_min: 50.0           # 考虑可疑的最低CPU使用率
    cpu_mean: 80.0          # 考虑可疑的平均CPU使用率
    cpu_time_growth_rate: 0.5  # 考虑可疑的CPU时间增长率
    cpu_autocorrelation: 0.7   # 考虑可疑的CPU使用自相关性
    cpu_spectral_entropy: 1.5   # 考虑可疑的CPU使用谱熵
  
  # 与加密货币挖矿软件相关的关键字
  mining_keywords:
    - "miner"
    - "xmr"
    - "monero"
    - "eth"
    - "ethereum"
    - "btc"
    - "bitcoin"
    - "stratum"
    - "mining"
    - "hashrate"
    - "cryptonight"
    - "ethash"
    - "zcash"
    - "equihash"
    - "randomx"
    - "coin"
    - "nicehash"
    - "pool"
  
  # CPU分析器配置
  profiler_config:
    # 采样间隔（秒）
    sampling_interval: 5
    
    # 历史记录中保留的样本数量
    history_length: 12
  
  # 机器学习配置
  ml_config:
    # 存储ML模型的目录
    models_dir: "/var/lib/sharpeye/models"
    
    # 是否在可用时使用ML检测
    use_ml: true
```

## 检测能力

1. **CPU使用模式分析**：
   - 分析CPU使用稳定性和一致性
   - 检测挖矿程序典型的持续高CPU使用率
   - 识别挖矿算法独特的周期性模式
   - 测量CPU使用自相关性和谱熵

2. **基于机器学习的检测**：
   - 使用ML模型识别加密货币挖矿行为
   - 特征包括CPU使用模式、内存使用和系统负载
   - 能够基于行为模式检测以前未知的加密货币挖矿程序
   - 在没有训练模型的情况下使用启发式回退操作

3. **命令和进程分析**：
   - 识别进程命令中与挖矿相关的关键字
   - 检测从可疑位置运行的进程
   - 与已知挖矿二进制模式交叉引用

4. **时间序列行为监控**：
   - 随时间跟踪进程资源使用情况
   - 识别CPU/内存使用的一致增长模式
   - 检测挖矿算法特有的周期性行为

5. **异常检测**：
   - 将当前进程与基线进行比较
   - 标记具有加密货币挖矿特征的新进程
   - 识别与挖矿活动相关的系统负载变化

## 集成点

- 与系统资源模块接口以获取额外上下文
- 与进程模块协同工作，关联其他可疑行为
- 可以在连续后台监控模式下运行
- 维护基线数据以供将来比较

## 机器学习方面

该模块包括一个用于识别加密货币挖矿程序的机器学习框架：

1. **特征工程**：
   - CPU使用统计（平均值、标准差、最小/最大值）
   - CPU稳定性指标（随时间变化）
   - CPU/内存关系特征
   - CPU增长率和模式特征
   - 频域特征（谱熵、自相关性）

2. **模型管理**：
   - 模型可以使用标记数据离线训练
   - 从模型目录加载预训练模型
   - 如果没有可用模型，则优雅地回退到启发式检测
   - 随着检测技术的发展，模型可以更新或替换

3. **特征提取**：
   - CPU使用模式的时间序列处理
   - 从进程行为计算统计特征
   - 高级特征，包括谱分析和自相关性
   - 针对运行时分析的低开销优化

机器学习组件旨在随着时间改进检测准确性，特别是对于可能逃避更简单检测方法的复杂挖矿程序。